<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benefits Illustrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDF8F0; /* Beige */
            color: #374151; /* Dark Gray */
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #D1D5DB;
            background-color: #F9FAFB;
            color: #1F2937;
            font-weight: 500;
        }
        .form-input:focus, .form-select:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #4A909E;
            box-shadow: 0 0 0 2px rgba(74, 144, 158, 0.5);
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        .form-input[readonly] {
            background-color: #E5E7EB;
            cursor: not-allowed;
        }
        .form-select:disabled {
            background-color: #E5E7EB;
            cursor: not-allowed;
            color: #9CA3AF;
        }
        .error-message {
            display: none;
            color: #DC2626;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .input-with-prefix .form-input {
            padding-left: 2.5rem;
        }
        .reinvest-btn {
            width: 36px;
            height: 36px;
            background-color: #4A909E;
            color: white;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 2px solid #FDF8F0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .reinvest-btn:hover {
            background-color: #3a7580;
        }
        .reinvest-btn:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .footer-input {
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #9CA3AF;
            color: white;
            padding: 0.25rem 0;
            width: 200px;
        }
        .footer-input:focus {
            outline: none;
            border-bottom-color: white;
        }
        /* Section Separation */
        .section-alt {
            background-color: #F9FAFB; /* Very light gray */
        }
        /* Animation for updated values */
        @keyframes flash {
            0% { background-color: transparent; }
            25% { background-color: rgba(74, 144, 158, 0.2); }
            100% { background-color: transparent; }
        }
        .flash-update {
            animation: flash 1s ease-out;
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-[#4A909E] text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold">Benefits Illustrator</h1>
        </div>
    </header>

    <main class="container mx-auto">

        <section id="calculator-input" class="py-8 md:py-12">
            <h3 class="text-2xl font-bold text-center mb-8">Part 1: Client & Policy Details</h3>
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-4xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="md:col-span-2">
                        <label for="clientName" class="form-label">Name</label>
                        <input type="text" id="clientName" class="form-input" placeholder="">
                    </div>
                     <div>
                        <label for="clientDOB" class="form-label">Date of Birth</label>
                        <input type="date" id="clientDOB" class="form-input">
                    </div>
                    <div>
                        <label for="clientANB" class="form-label">Age Next Birthday (ANB)</label>
                        <input type="number" id="clientANB" class="form-input" placeholder="e.g., 45">
                    </div>
                    
                    <hr class="md:col-span-2 my-4">

                    <div>
                        <label for="paymentTerm" class="form-label">Payment Term</label>
                        <select id="paymentTerm" class="form-select">
                            <option value="5">5 Years</option>
                            <option value="10" selected>10 Years</option>
                            <option value="20">20 Years</option>
                        </select>
                    </div>
                     <div>
                        <label for="coverageTerm" class="form-label">Coverage Until Age</label>
                        <select id="coverageTerm" class="form-select">
                            <option value="80" selected>Age 80</option>
                            <option value="100">Age 100</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="policyTerm" class="form-label">Policy Term (Years)</label>
                        <input type="text" id="policyTerm" class="form-input" readonly>
                    </div>
                    
                    <hr class="md:col-span-2 my-4">
                    
                    <div class="md:col-span-2 space-y-4">
                        <div>
                            <label for="annualContribution" class="form-label">How much premium do you plan to pay annually? (Basic)</label>
                            <div class="relative input-with-prefix">
                                 <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">RM</span>
                                <input type="text" id="annualContribution" class="form-input" value="" placeholder="Min. RM 12,000">
                            </div>
                            <div id="contributionError" class="error-message"></div>
                        </div>
                        <div>
                            <label for="waiverPremium" class="form-label">Life Assured Waiver Plus Premium (Annual)</label>
                            <div class="relative input-with-prefix">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">RM</span>
                                <input type="text" id="waiverPremium" class="form-input" value="">
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-2 bg-gray-100 p-4 rounded-lg mt-2">
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-gray-800">Total Annual Premium</p>
                            <p id="totalAnnualPremium" class="font-bold text-xl text-gray-900">RM 0.00</p>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center text-sm text-gray-600 mt-3 pt-3 border-t">
                            <div>
                                <p class="font-medium">Half-Yearly</p>
                                <p id="halfYearlyDisplay" class="font-bold text-gray-800">RM 0.00</p>
                            </div>
                            <div>
                                <p class="font-medium">Quarterly</p>
                                <p id="quarterlyDisplay" class="font-bold text-gray-800">RM 0.00</p>
                            </div>
                            <div>
                                <p class="font-medium">Monthly</p>
                                <p id="monthlyDisplay" class="font-bold text-gray-800">RM 0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="how-it-works" class="py-8 md:py-12 section-alt">
            <div class="max-w-3xl mx-auto px-4">
                <h3 class="text-2xl font-bold text-center mb-2">Part 2: FlexIncome Allocation & Breakdown</h3>
                <p class="text-md text-gray-600 max-w-3xl mx-auto text-center mb-8">
                    Customise your FlexIncome
                </p>
                <div class="flex justify-between items-stretch gap-4">
                    <div class="w-1/2 bg-white p-4 rounded-lg text-center flex flex-col justify-between shadow">
                        <div>
                            <h4 class="font-bold text-lg text-[#4A909E]">💰 Regular payout to you</h4>
                            <p class="text-2xl font-bold" id="payoutValue">RM 0</p>
                             <div class="flex items-center justify-center my-2 h-[36px]">
                                <p class="font-bold text-xl" id="payoutPercentage">50%</p>
                             </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Total Received: <span id="totalPayoutValue" class="font-bold">RM 0</span></p>
                    </div>
                    <div class="w-1/2 bg-white p-4 rounded-lg text-center flex flex-col justify-between shadow">
                        <div>
                            <h4 class="font-bold text-lg text-[#4A909E]">📈 Reinvest for Growth</h4>
                            <p class="text-2xl font-bold" id="reinvestValue">RM 0</p>
                            <div class="flex items-center justify-center gap-4 my-2 h-[36px]">
                                <button id="decreaseReinvest" class="reinvest-btn">-</button>
                                <p class="font-bold text-xl w-16 text-center" id="reinvestPercentage">50%</p>
                                <button id="increaseReinvest" class="reinvest-btn">+</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Total Reinvested: <span id="totalReinvestValue" class="font-bold">RM 0</span></p>
                    </div>
                </div>
                <p class="text-center text-xs text-gray-500 mt-6">*The allocation between payout and reinvestment can be changed at any time to suit your needs.</p>

                <div class="mt-12">
                     <h4 class="text-xl font-bold text-center text-[#4A909E] mb-4">FlexIncome Annual Breakdown</h4>
                    <div class="bg-teal-50 p-6 rounded-lg border-2 border-dashed border-[#4A909E]">
                        <div id="flexIncomeBreakdown" class="mt-4">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="maturity-benefit" class="py-8 md:py-12">
             <h3 class="text-2xl font-bold text-center mb-8">Part 3: Your Policy Benefits</h3>
             <div class="max-w-2xl mx-auto space-y-6 px-4">
                <div class="bg-teal-50 p-6 rounded-lg text-center border-2 border-dashed border-[#4A909E]">
                    <h4 class="text-[#4A909E] font-semibold">Guaranteed Maturity Benefit</h4>
                    <p id="guaranteedMaturityValue" class="text-3xl font-bold text-teal-800 mt-2">RM 0</p>
                    <p class="text-sm text-gray-500 mt-1" id="guaranteedMaturityTerm">(At Age 80)</p>
                    <div id="maturityBreakdown" class="text-xs text-gray-600 mt-4 pt-4 border-t border-dashed border-teal-200 text-left">
                        <div class="flex justify-between">
                            <span>Basic Annualised Premium:</span>
                            <span id="basicAnnualPremiumValue" class="font-semibold">RM 0</span>
                        </div>
                        <div class="flex justify-between mt-1">
                            <span>Maturity Benefit Rate:</span>
                            <span id="maturityPercentageValue" class="font-semibold">0%</span>
                        </div>
                    </div>
                </div>
             </div>
        </section>

        <section id="maturity-projections" class="py-8 md:py-12 section-alt">
            <div class="max-w-4xl mx-auto px-4">
                <h3 class="text-2xl font-bold text-center mb-8">Part 4: Summary of Your Potential Maturity Payout</h3>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <p class="text-center text-gray-600 mb-6">The values below are projections that include your Guaranteed Maturity Benefit plus a non-guaranteed amount based on different fund performance scenarios.*</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="scenarioX" class="form-label text-center">Projected Payout (Low Scenario)</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">RM</span>
                                <input type="text" id="scenarioX" class="form-input text-center font-bold text-xl" value="">
                            </div>
                        </div>
                        <div>
                            <label for="scenarioY" class="form-label text-center">Projected Payout (High Scenario)</label>
                            <div class="relative mt-1">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">RM</span>
                                <input type="text" id="scenarioY" class="form-input text-center font-bold text-xl" value="">
                            </div>
                        </div>
                    </div>
                    <p class="text-center text-xs text-gray-500 mt-6">*The non-guaranteed amount is dependent on the performance of the underlying investment-linked funds. Please refer to the official Product Illustration for details.</p>
                </div>
            </div>
        </section>

        <section id="legacy-planning" class="py-8 md:py-12">
            <h3 class="text-2xl font-bold text-center mb-8">Part 5: A Legacy for Generations</h3>
            <div class="max-w-4xl mx-auto space-y-8 px-4">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex items-start mb-4">
                        <div class="text-3xl mr-4">🎁</div>
                        <div>
                            <h4 class="text-xl font-bold text-[#4A909E]">Policy Split Option</h4>
                            <p class="text-gray-600 mt-1">A first in Malaysia. After your premium term, you can split your policy to seamlessly transfer wealth. You can split your plan twice, creating up to 16 policies in total.</p>
                            <p class="text-xs text-gray-500 mt-2">The stamp duty at the prevailing rate may be applicable for Policy Split Option.</p>
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                        <div class="inline-block text-center">
                            <span class="text-4xl">👤</span>
                            <p class="font-semibold text-gray-700">1st Generation (You)</p>
                        </div>
                        <div class="flex justify-center mt-2">
                            <div class="w-px bg-gray-300 h-6"></div>
                        </div>
                        <div class="flex justify-center mt-2">
                            <div class="w-1/2 h-px bg-gray-300"></div>
                        </div>
                        <div class="flex justify-around items-start mt-2">
                            <div class="w-1/2 text-center relative">
                                <div class="w-px bg-gray-300 h-6 absolute top-0 left-1/2"></div>
                                <span class="text-3xl">👤</span>
                                <p class="text-sm font-semibold text-gray-600">2nd Generation</p>
                                <div class="flex justify-center mt-2">
                                    <div class="w-2/3 h-px bg-gray-300"></div>
                                </div>
                                <div class="flex justify-around mt-2">
                                    <div class="w-1/2 text-center relative">
                                        <div class="w-px bg-gray-300 h-4 absolute top-0 left-1/2"></div>
                                        <span class="text-2xl">👤</span>
                                        <p class="text-xs text-gray-500">3rd Gen</p>
                                    </div>
                                    <div class="w-1/2 text-center relative">
                                        <div class="w-px bg-gray-300 h-4 absolute top-0 left-1/2"></div>
                                        <span class="text-2xl">👤</span>
                                        <p class="text-xs text-gray-500">3rd Gen</p>
                                    </div>
                                </div>
                            </div>
                            <div class="w-1/2 text-center relative">
                                 <div class="w-px bg-gray-300 h-6 absolute top-0 left-1/2"></div>
                                 <span class="text-3xl">👤</span>
                                 <p class="text-sm font-semibold text-gray-600">2nd Generation</p>
                                 <div class="flex justify-center mt-2">
                                    <div class="w-2/3 h-px bg-gray-300"></div>
                                </div>
                                <div class="flex justify-around mt-2">
                                    <div class="w-1/2 text-center relative">
                                        <div class="w-px bg-gray-300 h-4 absolute top-0 left-1/2"></div>
                                        <span class="text-2xl">👤</span>
                                        <p class="text-xs text-gray-500">3rd Gen</p>
                                    </div>
                                    <div class="w-1/2 text-center relative">
                                        <div class="w-px bg-gray-300 h-4 absolute top-0 left-1/2"></div>
                                        <span class="text-2xl">👤</span>
                                        <p class="text-xs text-gray-500">3rd Gen</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <p class="text-xs text-gray-400 mt-4">Diagram illustrates splitting into two policies per generation. You can split into up to four.</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                     <div class="flex items-start">
                        <div class="text-3xl mr-4">🔄</div>
                        <div>
                            <h4 class="text-xl font-bold text-[#4A909E]">Alternate Life Assured</h4>
                            <p class="text-gray-600 mt-1">You can appoint an Alternate Life Assured. In the event of your passing, the policy doesn't have to end. It can continue to protect and grow for your chosen loved one, ensuring your financial plan endures for the next generation.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="safety-net" class="py-8 md:py-12 section-alt">
            <div class="max-w-4xl mx-auto px-4">
                <h3 class="text-2xl font-bold text-center mb-8">Part 6: In Case of the Unexpected</h3>
                <div class="bg-white p-6 pb-10 rounded-lg shadow-lg">
                    <div class="text-center mb-6">
                        <p class="font-semibold text-lg">In the unfortunate event of death before the policy matures (at <span id="maturityAgeText">Age 80</span>)...</p>
                        <div class="mt-4 inline-flex items-center">
                            <span class="text-2xl mr-2">🤔</span>
                            <p class="font-bold text-gray-700">Is there an Alternate Life Assured appointed?</p>
                        </div>
                    </div>
                    <div class="flex justify-center mt-2">
                        <div class="w-px bg-gray-300 h-6"></div>
                    </div>
                    <div class="flex justify-center mt-2">
                        <div class="w-2/3 h-px bg-gray-300"></div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6 mt-2">
                        <div class="text-center">
                            <div class="w-px bg-gray-300 h-6 mx-auto"></div>
                            <div class="bg-red-100 border-2 border-dashed border-red-300 rounded-lg p-4 h-full">
                                <p class="font-bold text-red-700">NO</p>
                                <div class="text-3xl my-2">❤️</div>
                                <h4 class="font-bold text-lg text-red-800">Death Benefit is Payable</h4>
                                <p class="text-xs text-gray-600 mt-2">The HIGHER of:</p>
                                <ul class="text-xs text-left mt-2 space-y-1 list-disc list-inside">
                                    <li>105% of Total Basic Premium Paid (less FlexIncome paid OR</li>
                                    <li>Guaranteed Surrender Value</li>
                                </ul>
                                <p class="text-xs text-gray-600 mt-1">+ Investment Account Value (if any)</p>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="w-px bg-gray-300 h-6 mx-auto"></div>
                            <div class="bg-green-100 border-2 border-dashed border-green-300 rounded-lg p-4 h-full">
                                <p class="font-bold text-green-700">YES</p>
                                <div class="text-3xl my-2">🤝</div>
                                <h4 class="font-bold text-lg text-green-800">Compassionate Benefit is Payable</h4>
                                <ul class="text-xs text-left mt-2 space-y-1 list-disc list-inside">
                                    <li>10% of Basic Annual Premium (capped at RM5,000)</li>
                                    <li>The policy continues for the Alternate Life Assured</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <footer class="bg-gray-800 text-white mt-12 p-8 text-center">
        <div class="max-w-4xl mx-auto text-sm text-gray-300 mb-6">
            <div class="flex justify-between">
                <div>
                    Prepared for: <span id="preparedForName" class="font-semibold">Client</span>
                </div>
                <div>
                    Prepared by: <input type="text" id="preparedByName" class="footer-input" placeholder="Your Name">
                </div>
            </div>
        </div>
        <p>This plan is a long-term financial commitment designed to meet your specific needs for growth and security.</p>
        <p class="mt-2 text-sm text-gray-400">This illustrator is for illustrative purposes only. The actual policy benefits and terms are subject to the policy contract.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            let reinvestPercent = 50;

            const maturityRules = {
                80: { 5: 450, 10: 850, 20: 1200 },
                100: { 5: 500, 10: 1000, 20: 1500 }
            };
    
            const flexIncomeRules = {
                age80: {
                    entry_1_50: {
                        5: { periods: [{ from: 1, to: 1, percent: 12.5 }, { from: 2, to: 6, percent: 12.5 }, { from: 7, to: 30, percent: 12.5 }, { from: 31, to: 60, percent: 15.0 }, { from: 61, to: 79, percent: 20.0 }] },
                        10: { periods: [{ from: 1, to: 1, percent: 22.5 }, { from: 2, to: 6, percent: 22.5 }, { from: 7, to: 30, percent: 22.5 }, { from: 31, to: 60, percent: 25.0 }, { from: 61, to: 79, percent: 35.0 }] },
                        20: { periods: [{ from: 1, to: 1, percent: 25.0 }, { from: 2, to: 6, percent: 30.0 }, { from: 7, to: 30, percent: 45.0 }, { from: 31, to: 60, percent: 45.0 }, { from: 61, to: 79, percent: 60.0 }] }
                    }
                },
                age100: {
                    entry_1_55: {
                        5: { periods: [{ from: 1, to: 1, percent: 12.5 }, { from: 2, to: 6, percent: 12.5 }, { from: 7, to: 10, percent: 12.5 }, { from: 11, to: 20, percent: 13.5 }, { from: 21, to: 30, percent: 13.5 }, { from: 31, to: 40, percent: 15.0 }, { from: 41, to: 60, percent: 17.5 }, { from: 61, to: 80, percent: 22.5 }, { from: 81, to: 99, percent: 22.5 }] },
                        10: { periods: [{ from: 1, to: 1, percent: 22.5 }, { from: 2, to: 6, percent: 22.5 }, { from: 7, to: 10, percent: 22.5 }, { from: 11, to: 20, percent: 25.0 }, { from: 21, to: 30, percent: 25.0 }, { from: 31, to: 40, percent: 30.0 }, { from: 41, to: 60, percent: 32.5 }, { from: 61, to: 80, percent: 42.5 }, { from: 81, to: 99, percent: 42.5 }] },
                        20: { periods: [{ from: 1, to: 1, percent: 25.0 }, { from: 2, to: 6, percent: 30.0 }, { from: 7, to: 10, percent: 45.0 }, { from: 11, to: 20, percent: 45.0 }, { from: 21, to: 30, percent: 46.0 }, { from: 31, to: 40, percent: 47.5 }, { from: 41, to: 60, percent: 47.5 }, { from: 61, to: 80, percent: 62.5 }, { from: 81, to: 99, percent: 62.5 }] }
                    },
                     entry_56_70: {
                        5: { periods: [{ from: 1, to: 20, percent: 10.0 }, { from: 21, to: 30, percent: 10.0 }, { from: 31, to: 44, percent: 17.5 }] },
                        10: { periods: [{ from: 1, to: 20, percent: 20.0 }, { from: 21, to: 30, percent: 20.0 }, { from: 31, to: 44, percent: 35.0 }] }
                    }
                }
            };
    
            const minimums = { 5: 30000, 10: 12000, 20: 12000 };
            
            const clientNameEl = document.getElementById('clientName');
            const clientDOBEl = document.getElementById('clientDOB');
            const clientANBEl = document.getElementById('clientANB');
            const paymentTermEl = document.getElementById('paymentTerm');
            const coverageTermEl = document.getElementById('coverageTerm');
            const policyTermEl = document.getElementById('policyTerm');
            const annualContributionEl = document.getElementById('annualContribution');
            const waiverPremiumEl = document.getElementById('waiverPremium');
            const contributionErrorEl = document.getElementById('contributionError');
            
            const totalAnnualPremiumEl = document.getElementById('totalAnnualPremium');
            const halfYearlyDisplayEl = document.getElementById('halfYearlyDisplay');
            const quarterlyDisplayEl = document.getElementById('quarterlyDisplay');
            const monthlyDisplayEl = document.getElementById('monthlyDisplay');
    
            const guaranteedMaturityValueEl = document.getElementById('guaranteedMaturityValue');
            const guaranteedMaturityTermEl = document.getElementById('guaranteedMaturityTerm');
            const maturityBreakdownEl = document.getElementById('maturityBreakdown');
            const basicAnnualPremiumValueEl = document.getElementById('basicAnnualPremiumValue');
            const maturityPercentageValueEl = document.getElementById('maturityPercentageValue');

            const flexIncomeBreakdownEl = document.getElementById('flexIncomeBreakdown');
            
            const payoutValueEl = document.getElementById('payoutValue');
            const reinvestValueEl = document.getElementById('reinvestValue');
            const payoutPercentageEl = document.getElementById('payoutPercentage');
            const reinvestPercentageEl = document.getElementById('reinvestPercentage');
            const decreaseReinvestBtn = document.getElementById('decreaseReinvest');
            const increaseReinvestBtn = document.getElementById('increaseReinvest');
            const totalPayoutValueEl = document.getElementById('totalPayoutValue');
            const totalReinvestValueEl = document.getElementById('totalReinvestValue');
            
            const scenarioXEl = document.getElementById('scenarioX');
            const scenarioYEl = document.getElementById('scenarioY');
            const maturityAgeTextEl = document.getElementById('maturityAgeText');
            const preparedForNameEl = document.getElementById('preparedForName');
    
            const formatter = new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR', minimumFractionDigits: 0, maximumFractionDigits: 0 });
            const numFormatter = new Intl.NumberFormat('en-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const currencyFormatter2dp = new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR', minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
            function validateCoverageOptions() {
                const anb = parseInt(clientANBEl.value) || 0;
                const coverage80Option = coverageTermEl.querySelector('option[value="80"]');
                coverage80Option.disabled = false;
                if (anb >= 51) {
                    coverage80Option.disabled = true;
                    if (coverageTermEl.value === '80') {
                        coverageTermEl.value = '100';
                    }
                }
            }
    
            function getFlexIncomePercent(year, rules) {
                if (!rules || !rules.periods) return 0;
                for (const period of rules.periods) {
                    if (year >= period.from && year <= period.to) {
                        return period.percent;
                    }
                }
                return 0;
            }
    
            function calculateANB(dob) {
                if (!dob) return '';
                const today = new Date();
                const birthDate = new Date(dob);
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age + 1;
            }
            
            function formatNumberInput(e) {
                let value = e.target.value.replace(/[^0-9.]/g, '');
                let parts = value.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                if (parts[1]) {
                    parts[1] = parts[1].substring(0, 2);
                }
                e.target.value = parts.join('.');
            }
    
            function unformatNumber(value) {
                return parseFloat(value.replace(/,/g, '')) || 0;
            }
    
            function validateContribution() {
                const paymentTerm = parseInt(paymentTermEl.value);
                const annualPremium = unformatNumber(annualContributionEl.value);
                const min = minimums[paymentTerm];
    
                annualContributionEl.placeholder = `Min. RM ${numFormatter.format(min)}`;
    
                if (annualPremium > 0 && annualPremium < min) {
                    contributionErrorEl.textContent = `Minimum for a ${paymentTerm}-year term is ${formatter.format(min)}.`;
                    contributionErrorEl.style.display = 'block';
                    annualContributionEl.classList.add('border-red-500');
                    return false;
                }
                
                contributionErrorEl.style.display = 'none';
                annualContributionEl.classList.remove('border-red-500');
                return true;
            }
    
            function triggerFlash(element) {
                element.classList.remove('flash-update');
                void element.offsetWidth; // Trigger reflow
                element.classList.add('flash-update');
            }

            function updateFlexAllocationDisplay(firstYearFlexIncome, totalFlexIncomeOverTerm) {
                const payoutPercent = 100 - reinvestPercent;
                const annualReinvestAmount = firstYearFlexIncome * (reinvestPercent / 100);
                const annualPayoutAmount = firstYearFlexIncome * (payoutPercent / 100);
                const totalReinvestAmount = totalFlexIncomeOverTerm * (reinvestPercent / 100);
                const totalPayoutAmount = totalFlexIncomeOverTerm * (payoutPercent / 100);

                if (unformatNumber(payoutValueEl.textContent) !== annualPayoutAmount) {
                    payoutValueEl.textContent = formatter.format(annualPayoutAmount);
                    triggerFlash(payoutValueEl);
                }
                if (unformatNumber(reinvestValueEl.textContent) !== annualReinvestAmount) {
                    reinvestValueEl.textContent = formatter.format(annualReinvestAmount);
                    triggerFlash(reinvestValueEl);
                }
                payoutPercentageEl.textContent = `${payoutPercent}%`;
                reinvestPercentageEl.textContent = `${reinvestPercent}%`;
                if (unformatNumber(totalPayoutValueEl.textContent) !== totalPayoutAmount) {
                    totalPayoutValueEl.textContent = formatter.format(totalPayoutAmount);
                    triggerFlash(totalPayoutValueEl);
                }
                if (unformatNumber(totalReinvestValueEl.textContent) !== totalReinvestAmount) {
                    totalReinvestValueEl.textContent = formatter.format(totalReinvestAmount);
                    triggerFlash(totalReinvestValueEl);
                }
                decreaseReinvestBtn.disabled = reinvestPercent === 0;
                increaseReinvestBtn.disabled = reinvestPercent === 100;
            }

            function updateFullProposal() {
                validateCoverageOptions(); 
                const isValidContribution = validateContribution();
    
                const anb = parseInt(clientANBEl.value) || 0;
                const paymentTerm = parseInt(paymentTermEl.value);
                const coverageTerm = parseInt(coverageTermEl.value);
                const annualContribution = unformatNumber(annualContributionEl.value);
                const waiverPremium = unformatNumber(waiverPremiumEl.value);
                const totalAnnualPremium = annualContribution + waiverPremium;
    
                preparedForNameEl.textContent = clientNameEl.value || 'Client';

                totalAnnualPremiumEl.textContent = currencyFormatter2dp.format(totalAnnualPremium);
                monthlyDisplayEl.textContent = `RM ${numFormatter.format(totalAnnualPremium / 12)}`;
                quarterlyDisplayEl.textContent = `RM ${numFormatter.format(totalAnnualPremium / 4)}`;
                halfYearlyDisplayEl.textContent = `RM ${numFormatter.format(totalAnnualPremium / 2)}`;
                
                const policyTerm = coverageTerm - anb;
                policyTermEl.value = policyTerm > 0 ? `${policyTerm} years` : '';
    
                let rulesKey = `age${coverageTerm}`;
                let entryKey;
    
                if (coverageTerm == 80) {
                    if (anb >= 1 && anb <= 50) {
                        entryKey = 'entry_1_50';
                    }
                } else if (coverageTerm == 100) {
                    if (anb >= 1 && anb <= 55) {
                        entryKey = 'entry_1_55';
                    } else if (anb >= 56 && anb <= 70) {
                        entryKey = 'entry_56_70';
                    }
                }
                
                const rules = flexIncomeRules[rulesKey]?.[entryKey]?.[paymentTerm];
                
                guaranteedMaturityTermEl.textContent = `(At Age ${coverageTerm})`;
                maturityAgeTextEl.textContent = `Age ${coverageTerm}`;
                flexIncomeBreakdownEl.innerHTML = '';
                
                const maturityPercent = maturityRules[coverageTerm]?.[paymentTerm];
                if(maturityPercent && annualContribution > 0 && isValidContribution) {
                    const maturityBenefit = annualContribution * (maturityPercent / 100);
                    if (unformatNumber(guaranteedMaturityValueEl.textContent) !== maturityBenefit) {
                        guaranteedMaturityValueEl.textContent = formatter.format(maturityBenefit);
                        triggerFlash(guaranteedMaturityValueEl);
                    }
                    
                    basicAnnualPremiumValueEl.textContent = formatter.format(annualContribution);
                    maturityPercentageValueEl.textContent = `${maturityPercent.toLocaleString()}%`;
                    maturityBreakdownEl.style.display = 'block';

                } else {
                    guaranteedMaturityValueEl.textContent = 'RM 0';
                    maturityBreakdownEl.style.display = 'none';
                }
    
                let totalFlexIncomeOverTerm = 0;
                if (rules && policyTerm > 0 && annualContribution > 0 && isValidContribution) {
                    for (let year = 1; year <= policyTerm; year++) {
                        const yearlyPercent = getFlexIncomePercent(year, rules);
                        totalFlexIncomeOverTerm += annualContribution * (yearlyPercent / 100);
                    }
                }
    
                if (!rules || !anb || !annualContribution || !isValidContribution) {
                    flexIncomeBreakdownEl.innerHTML = '<p class="text-gray-500 text-center">Please complete all inputs correctly to see the benefits.</p>';
                    updateFlexAllocationDisplay(0, 0);
                    return;
                }
    
                rules.periods.forEach(period => {
                    if (period.from > policyTerm) return;
    
                    const div = document.createElement('div');
                    const flexIncomeValue = annualContribution * (period.percent / 100);
                    div.className = 'flex justify-between items-center py-2 border-b border-teal-200 last:border-b-0';
                    
                    const displayTo = Math.min(period.to, policyTerm);
    
                    let yearText = `Policy Year ${period.from}`;
                    if (period.from !== displayTo) {
                       yearText = `Policy Years ${period.from}-${displayTo}`;
                    }
                    
                    let ageText = `Age ${anb + period.from}`;
                     if (period.from !== displayTo) {
                       ageText = `Age ${anb + period.from}-${anb + displayTo}`;
                    }
    
                    div.innerHTML = `
                        <span class="text-gray-600">${yearText} / ${ageText}</span>
                        <div class="text-right">
                            <p class="font-bold text-lg text-teal-800">${formatter.format(flexIncomeValue)}</p>
                            <p class="text-xs text-gray-500">${period.percent}%</p>
                        </div>`;
                    flexIncomeBreakdownEl.appendChild(div);
                });
    
                const firstYearFlexPercent = getFlexIncomePercent(1, rules);
                const firstYearFlexIncome = annualContribution * (firstYearFlexPercent / 100);
                updateFlexAllocationDisplay(firstYearFlexIncome, totalFlexIncomeOverTerm);
            }
    
            clientNameEl.addEventListener('input', updateFullProposal);
            clientDOBEl.addEventListener('input', (e) => {
                const anb = calculateANB(e.target.value);
                if (anb) {
                    clientANBEl.value = anb;
                    updateFullProposal();
                }
            });
            
            annualContributionEl.addEventListener('input', (e) => {
                formatNumberInput(e);
                updateFullProposal();
            });
            waiverPremiumEl.addEventListener('input', (e) => {
                formatNumberInput(e);
                updateFullProposal();
            });
            scenarioXEl.addEventListener('input', formatNumberInput);
            scenarioYEl.addEventListener('input', formatNumberInput);
    
            [clientANBEl, paymentTermEl, coverageTermEl].forEach(el => {
                el.addEventListener('input', updateFullProposal);
            });
            
            decreaseReinvestBtn.addEventListener('click', () => {
                if (reinvestPercent > 0) {
                    reinvestPercent -= 10;
                    updateFullProposal();
                }
            });

            increaseReinvestBtn.addEventListener('click', () => {
                if (reinvestPercent < 100) {
                    reinvestPercent += 10;
                    updateFullProposal();
                }
            });
            
            updateFullProposal();
        });
    </script>
</body>
</html>
